name: Tests
on: [ workflow_call ]

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: install
        run: make install

      - name: protoc
        run: make protoc

      - name: test
        run: make test

      - name: upload protoc
        uses: actions/upload-artifact@v4
        with:
          name: protoc
          path: packages/inspector/src/lib/data-layer/proto/gen

  E2E:
    needs: unit
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest] #[ macos-latest, windows-latest ]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: install
        run: make install

      - name: install Playwright browsers
        run: npx playwright install

      - name: download protoc
        uses: actions/download-artifact@v4
        with:
          name: protoc
          path: packages/inspector/src/lib/data-layer/proto/gen

      - name: build inspector
        run: make build-inspector
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"

      - name: e2e
        shell: bash
        run: |
          cd packages/inspector
          # Start server in background (must be in same step to persist)
          # Note: Background processes started with & don't persist between steps in GitHub Actions
          # Using 127.0.0.1 to match what tests expect (setup.ts defaults to 127.0.0.1:8000)
          npx http-server public -p 8000 --cors -a 127.0.0.1 &
          SERVER_PID=$!
          
          # Wait for server to be ready
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:8000 > /dev/null 2>&1; then
              echo "✅ Server is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "❌ Server failed to start after 30 seconds"
              exit 1
            fi
            sleep 1
          done
          
          # Run tests (server continues in background)
          cd ../..
          make test-e2e
          
          # Cleanup
          kill $SERVER_PID 2>/dev/null || true
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
